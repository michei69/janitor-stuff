// ==UserScript==
// @name         janitor stuff
// @namespace    https://github.com/michei69/janitor-stuff
// @version      2025-12-13
// @description  fixes and qol for janitor ai
// @author       michei69
// @match        *://janitorai.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=janitorai.com
// @grant        GM.xmlHttpRequest
// @sandbox      MAIN_WORLD
// @run-at       document-start
// @downloadURL  https://raw.githubusercontent.com/michei69/janitor-stuff/refs/heads/master/dist/index.user.js
// @updateURL    https://raw.githubusercontent.com/michei69/janitor-stuff/refs/heads/master/dist/index.user.js
// @supportURL   https://github.com/michei69/janitor-stuff
// @homepage     https://github.com/michei69/janitor-stuff
// ==/UserScript==

"use strict";(()=>{function J(e){e=e.replace(/\n?\s*<(thought|thoughts)>[\s\S]*?<\/(thought|thoughts)>\s*\n?/g,"").replace(/<(system|response)>|<\/response>/g,"").replace(/\n?\s*<think>[\s\S]*?<\/think>\s*\n?/g,"").replace("</think>","");let t="*";return e.replace(/[«“”„‟⹂❞❝]/g,'"').split(`
`).map(o=>{let a=o.trim();if(a==="")return"";let i=a.replace(/\*/g,"");return i.includes('"')||i.includes("`")?i.split(/("[\s\S]*?"|`[\s\S]*?`)/).map(s=>s.startsWith('"')&&s.endsWith('"')||s.startsWith("`")&&s.endsWith("`")?s:s.trim()!==""?`${t}${s.trim()}${t}`:"").filter(Boolean).join(" "):`${t}${i}${t}`}).join(`
`)}async function d(){if(!(typeof wnd.Janitor.Stores.generationStore>"u")){if(typeof wnd.Janitor.Stores.generationStore.runGenerateAnswer<"u"){if(wnd.Janitor.Stores.generationStore.runGenerateAnswer.patched)return;typeof wnd.Janitor.Generation.Answer>"u"&&(wnd.Janitor.Generation.Answer=wnd.Janitor.Stores.generationStore.runGenerateAnswer),wnd.Janitor.Stores.generationStore.runGenerateAnswer=(e,t)=>wnd.Janitor.Generation.Answer(e,n=>{wnd.Janitor.Hooks.Delta(n),t(n)}).then(wnd.Janitor.Hooks.StopStream),wnd.Janitor.Stores.generationStore.runGenerateAnswer.patched=!0}typeof wnd.Janitor.Stores.generationStore.runGenerateAlternative<"u"&&(typeof wnd.Janitor.Generation.Alternative>"u"&&(wnd.Janitor.Generation.Alternative=wnd.Janitor.Stores.generationStore.runGenerateAlternative),wnd.Janitor.Stores.generationStore.runGenerateAlternative=e=>wnd.Janitor.Generation.Alternative(t=>{wnd.Janitor.Hooks.Delta(t),e(t)}).then(wnd.Janitor.Hooks.StopStream)),typeof wnd.Janitor.Stores.generationStore.runRegenerate<"u"&&(typeof wnd.Janitor.Generation.Regenerate>"u"&&(wnd.Janitor.Generation.Regenerate=wnd.Janitor.Stores.generationStore.runRegenerate),wnd.Janitor.Stores.generationStore.runRegenerate=e=>wnd.Janitor.Generation.Regenerate(t=>{wnd.Janitor.Hooks.Delta(t),e(t)}).then(wnd.Janitor.Hooks.StopStream)),typeof wnd.Janitor.Stores.generationStore.runContinueMessage<"u"&&(typeof wnd.Janitor.Generation.Continue>"u"&&(wnd.Janitor.Generation.Continue=wnd.Janitor.Stores.generationStore.runContinueMessage),wnd.Janitor.Stores.generationStore.runContinueMessage=(e,t)=>wnd.Janitor.Generation.Continue(e,n=>{wnd.Janitor.Hooks.Delta(n),t(n)}).then(wnd.Janitor.Hooks.StopStream)),typeof wnd.Janitor.Stores.generationStore.stopStream<"u"&&(typeof wnd.Janitor.Generation.Stop>"u"&&(wnd.Janitor.Generation.Stop=wnd.Janitor.Stores.generationStore.stopStream),wnd.Janitor.Stores.generationStore.stopStream=()=>(wnd.Janitor.Hooks.StopStream(),wnd.Janitor.Generation.Stop())),typeof wnd.Janitor.Stores.generationStore.saveNewMessageAndApplyId<"u"&&(typeof wnd.Janitor.Generation.saveNewMessage>"u"&&(wnd.Janitor.Generation.saveNewMessage=wnd.Janitor.Stores.generationStore.saveNewMessageAndApplyId),wnd.Janitor.Stores.generationStore.saveNewMessageAndApplyId=e=>(e.is_bot&&!e.message.toLowerCase().includes("{{user}}")&&!e.message.toLowerCase().includes("{{char}}")&&(e.message=J(e.message)),wnd.Janitor.Hooks.SaveMessage(e),wnd.Janitor.Generation.saveNewMessage.call(wnd.Janitor.Stores.generationStore,e)))}}async function c(){let e=[...document.querySelectorAll("div")].filter(r=>r.innerHTML.includes("Hidden Gems")).pop();if(!e||e.querySelector("input[type=checkbox]"))return;let n=document.createElement("input");n.type="checkbox",n.style.marginLeft="8px",n.addEventListener("change",()=>{wnd.Janitor.HiddenGemsFurryFilter=n.checked}),e.appendChild(n)}function m(e){e.canBeDeleted=t=>!0,typeof e.canEditMessage_ORIGINAL>"u"&&(e.canEditMessage_ORIGINAL=e.canEditMessage),e.canEditMessage=t=>t.id==e.messages.at(0).id?e.canEditMessage_ORIGINAL.call(e,{...t,id:1}):e.canEditMessage_ORIGINAL.call(e,t),typeof e.chatStore<"u"&&typeof e.chatStore.bufferedMessageStore<"u"&&typeof e.chatStore.bufferedMessageStore.pauseBufferedStreaming<"u"&&typeof e.chatStore.bufferedMessageStore.unpauseBufferedStreaming<"u"&&(e.chatStore.bufferedMessageStore.pauseBufferedStreaming=e.chatStore.bufferedMessageStore.unpauseBufferedStreaming)}var p=e=>e.toLowerCase().endsWith("store");async function f(e){if(typeof e=="object"&&e)for(let t of Object.keys(e))try{if(wnd.Janitor.Stores[t])continue;if(t=="displayMessage"){wnd.Janitor.Toastify=e[t];continue}if(!p(t)||!e[t])continue;let n=t.split("-");wnd.Janitor.Stores[n[n.length-1]]=e[t],await f(e[t])}catch{continue}}async function T(){typeof wnd.Janitor.StoreProps.getCharacters>"u"||(typeof wnd.Janitor.StoreProps.getCharacters_ORIGINAL>"u"&&(wnd.Janitor.StoreProps.getCharacters_ORIGINAL=wnd.Janitor.StoreProps.getCharacters),wnd.Janitor.StoreProps.getCharacters=({page:e,...t})=>(t.special_mode=="hidden_gems"&&(t.proxyenabled=!0,t.tokens=500,t.tokens_mode="gte",t.tag_id=wnd.Janitor.HiddenGemsFurryFilter?[1,53]:[1]),wnd.Janitor.StoreProps.getCharacters_ORIGINAL({page:e,...t})))}function S(e,t,n){if(typeof e=="object"){for(let r of Object.keys(e))if(r.trim()=="messagesStore"&&m(e[r]),r.toLowerCase().includes("store")||typeof t=="string"&&t.toLowerCase().includes("store")){if(r.toLowerCase().includes("storeprops")){wnd.Janitor.StoreProps=e,T();continue}f(e[r]);break}}}async function g(){}async function u(){typeof wnd.Janitor.StoreProps>"u"||typeof wnd.Janitor.StoreProps.getCharacters>"u"||wnd.Janitor.StoreProps.getCharacters.patched||(typeof wnd.Janitor.StoreProps.getCharacters_ORIGINAL>"u"&&(wnd.Janitor.StoreProps.getCharacters_ORIGINAL=wnd.Janitor.StoreProps.getCharacters),wnd.Janitor.StoreProps.getCharacters=async(...e)=>{let t=await wnd.Janitor.StoreProps.getCharacters_ORIGINAL(...e);return wnd.Janitor.StoreProps.characters=wnd.Janitor.StoreProps.characters.filter(n=>n.is_proxy_enabled&&n.avatar!="placeholder-nsfw.webp").sort((n,r)=>n.total_tokens<r.total_tokens),console.warn("filtered characters",wnd.Janitor.StoreProps.characters.length),t},wnd.Janitor.StoreProps.getCharacters.patched=!0)}function h(){wnd.Janitor.TTSEnabled=!wnd.Janitor.TTSEnabled,localStorage.setItem("TTSEnabled",wnd.Janitor.TTSEnabled+""),console.log(`TTS is now ${wnd.Janitor.TTSEnabled?"enabled":"disabled"}`),wnd.Janitor.TTSEnabled?l():(wnd.Janitor.Hooks.Delta=(...e)=>{},wnd.Janitor.Hooks.StopStream=(...e)=>{},wnd.Janitor.Hooks.SaveMessage=e=>{})}function y(){wnd.Janitor.UseDeltaForTTS=!wnd.Janitor.UseDeltaForTTS,localStorage.setItem("UseDeltaForTTS",wnd.Janitor.UseDeltaForTTS+""),console.log(`Delta TTS is now ${wnd.Janitor.UseDeltaForTTS?"enabled":"disabled"}`)}function w(e){GM.xmlHttpRequest({method:"POST",url:"http://127.0.0.1:3246/tts",headers:{"Content-Type":"application/json"},data:JSON.stringify(e),onerror:function(t){console.error("Request failed:",t)}})}function b(e){let t=[],n=/(\*\*`.*?`\*\*|\*`.*?`\*|`.*?`|\*\*.*?\*\*|\*.*?\*|"[^"]*"|\S+)/g,r=e.match(n)||[];for(let o of r){let a=o,i="chat";o.startsWith("**`")&&o.endsWith("`**")?(a=o.slice(3,-3).trim(),i="thought"):o.startsWith("*`")&&o.endsWith("`*")?(a=o.slice(2,-2).trim(),i="thought"):o.startsWith("`")&&o.endsWith("`")?(a=o.slice(1,-1).trim(),i="thought"):o.startsWith("**")&&o.endsWith("**")?(a=o.slice(2,-2).trim(),i="action"):o.startsWith("*")&&o.endsWith("*")?(a=o.slice(1,-1).trim(),i="action"):o.startsWith('"')&&o.endsWith('"')&&(a=o.slice(1,-1).trim(),i="chat"),t.push({text:a,type:i})}return t}function l(){var e="";wnd.Janitor.Hooks.Delta=t=>{if(wnd.Janitor.UseDeltaForTTS)for(let n of[".","?","!","*"])t.includes(n)&&e.replaceAll(n,"").trim().length>0&&(w({text:e.trim()}),e="")},wnd.Janitor.Hooks.StopStream=()=>{wnd.Janitor.UseDeltaForTTS&&e.trim().length>0&&w({text:e.trim()})},wnd.Janitor.Hooks.SaveMessage=t=>{if(wnd.Janitor.UseDeltaForTTS||!t.is_bot)return;let n=t.message;if(n.trim().length>0)for(let r of b(n.trim()))w(r)}}(async()=>{let e=typeof unsafeWindow<"u"?unsafeWindow:window;globalThis.wnd=e,e.Janitor={ToggleTTS:h,ToggleDeltaTTS:y,UseDeltaForTTS:localStorage.getItem("UseDeltaForTTS")=="true",Hooks:{Delta:(...r)=>{},StopStream:(...r)=>{},SaveMessage:r=>{}},Toastify:null,Stores:{},StoreProps:{},TTSEnabled:localStorage.getItem("TTSEnabled")=="true",Generation:{},HiddenGemsFurryFilter:!1,Navigate:(...r)=>{},InitState:null};let t=Object.defineProperty;e.Object.defineProperty=(r,o,a)=>{let i=t(r,o,a);return document.body&&document.body.innerText.includes("security verification")||S(r,o,a),i};let n=Map.prototype.has;Map.prototype.has=function(...r){for(let o of this.keys())if(typeof o=="string"&&p(o)){f(Object.fromEntries(this));break}return n.call(this,...r)},e.Janitor.TTSEnabled&&l(),(async()=>{if(window.location.href.includes("/chat")){for(;typeof e.Janitor.Stores.generationStore>"u";)await new Promise(r=>setTimeout(r,100));await d()}})(),(async()=>{if(window.location.href.includes("/search")){for(;typeof e.Janitor.StoreProps>"u"||typeof e.Janitor.StoreProps.getCharacters>"u";)await new Promise(r=>setTimeout(r,100));await u()}})(),(async()=>{for(;typeof e.Janitor.Stores.navigatorStore>"u"||typeof e.Janitor.Stores.navigatorStore.navigate>"u";)await new Promise(a=>setTimeout(a,100));e.Janitor.Navigate=e.Janitor.Stores.navigatorStore.navigate;var r=window.location.href;new MutationObserver(a=>{window.location.href!=r&&(r=window.location.href,window.location.href.includes("/chat")?d():window.location.href.includes("/search")&&u(),c())}).observe(document.body,{childList:!0,subtree:!0})})(),console.log("Janitor qol n shi loaded!"),g(),await new Promise(r=>setTimeout(r,5e3)),unsafeWindow.Janitor.Toastify.showInfo("Loaded!"),c()})();})();
