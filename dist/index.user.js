// ==UserScript==
// @name         janitor stuff
// @namespace    https://github.com/michei69/janitor-stuff
// @version      2025-12-14
// @description  fixes and qol for janitor ai
// @author       michei69
// @match        *://janitorai.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=janitorai.com
// @grant        GM.xmlHttpRequest
// @sandbox      MAIN_WORLD
// @run-at       document-start
// @downloadURL  https://raw.githubusercontent.com/michei69/janitor-stuff/refs/heads/master/dist/index.user.js
// @updateURL    https://raw.githubusercontent.com/michei69/janitor-stuff/refs/heads/master/dist/index.user.js
// @supportURL   https://github.com/michei69/janitor-stuff
// @homepage     https://github.com/michei69/janitor-stuff
// ==/UserScript==

"use strict";(()=>{function _(e){e=e.replace(/\n?\s*<(thought|thoughts)>[\s\S]*?<\/(thought|thoughts)>\s*\n?/g,"").replace(/<(system|response)>|<\/response>/g,"").replace(/\n?\s*<think>[\s\S]*?<\/think>\s*\n?/g,"").replace("</think>","");let t="*";return e.replace(/[«“”„‟⹂❞❝]/g,'"').split(`
`).map(n=>{let i=n.trim();if(i==="")return"";let a=i.replace(/\*/g,"");return a.includes('"')||a.includes("`")?a.split(/("[\s\S]*?"|`[\s\S]*?`)/).map(s=>s.startsWith('"')&&s.endsWith('"')||s.startsWith("`")&&s.endsWith("`")?s:s.trim()!==""?`${t}${s.trim()}${t}`:"").filter(Boolean).join(" "):`${t}${a}${t}`}).join(`
`)}async function d(){if(!(typeof wnd.Janitor.Stores.generationStore>"u")){if(typeof wnd.Janitor.Stores.generationStore.runGenerateAnswer<"u"){if(wnd.Janitor.Stores.generationStore.runGenerateAnswer.patched)return;typeof wnd.Janitor.Generation.Answer>"u"&&(wnd.Janitor.Generation.Answer=wnd.Janitor.Stores.generationStore.runGenerateAnswer),wnd.Janitor.Stores.generationStore.runGenerateAnswer=(e,t)=>wnd.Janitor.Generation.Answer(e,r=>{wnd.Janitor.Hooks.Delta(r),t(r)}).then(wnd.Janitor.Hooks.StopStream),wnd.Janitor.Stores.generationStore.runGenerateAnswer.patched=!0}typeof wnd.Janitor.Stores.generationStore.runGenerateAlternative<"u"&&(typeof wnd.Janitor.Generation.Alternative>"u"&&(wnd.Janitor.Generation.Alternative=wnd.Janitor.Stores.generationStore.runGenerateAlternative),wnd.Janitor.Stores.generationStore.runGenerateAlternative=e=>wnd.Janitor.Generation.Alternative(t=>{wnd.Janitor.Hooks.Delta(t),e(t)}).then(wnd.Janitor.Hooks.StopStream)),typeof wnd.Janitor.Stores.generationStore.runRegenerate<"u"&&(typeof wnd.Janitor.Generation.Regenerate>"u"&&(wnd.Janitor.Generation.Regenerate=wnd.Janitor.Stores.generationStore.runRegenerate),wnd.Janitor.Stores.generationStore.runRegenerate=e=>wnd.Janitor.Generation.Regenerate(t=>{wnd.Janitor.Hooks.Delta(t),e(t)}).then(wnd.Janitor.Hooks.StopStream)),typeof wnd.Janitor.Stores.generationStore.runContinueMessage<"u"&&(typeof wnd.Janitor.Generation.Continue>"u"&&(wnd.Janitor.Generation.Continue=wnd.Janitor.Stores.generationStore.runContinueMessage),wnd.Janitor.Stores.generationStore.runContinueMessage=(e,t)=>wnd.Janitor.Generation.Continue(e,r=>{wnd.Janitor.Hooks.Delta(r),t(r)}).then(wnd.Janitor.Hooks.StopStream)),typeof wnd.Janitor.Stores.generationStore.stopStream<"u"&&(typeof wnd.Janitor.Generation.Stop>"u"&&(wnd.Janitor.Generation.Stop=wnd.Janitor.Stores.generationStore.stopStream),wnd.Janitor.Stores.generationStore.stopStream=()=>(wnd.Janitor.Hooks.StopStream(),wnd.Janitor.Generation.Stop())),typeof wnd.Janitor.Stores.generationStore.saveNewMessageAndApplyId<"u"&&(typeof wnd.Janitor.Generation.saveNewMessage>"u"&&(wnd.Janitor.Generation.saveNewMessage=wnd.Janitor.Stores.generationStore.saveNewMessageAndApplyId),wnd.Janitor.Stores.generationStore.saveNewMessageAndApplyId=e=>(e.is_bot&&!e.message.toLowerCase().includes("{{user}}")&&!e.message.toLowerCase().includes("{{char}}")&&(e.message=_(e.message)),wnd.Janitor.Hooks.SaveMessage(e),wnd.Janitor.Generation.saveNewMessage.call(wnd.Janitor.Stores.generationStore,e)))}}async function c(){let e=[...document.querySelectorAll("div")].filter(o=>o.innerHTML.includes("Hidden Gems")).pop();if(!e||e.querySelector("input[type=checkbox]"))return;let r=document.createElement("input");r.type="checkbox",r.style.marginLeft="8px",r.addEventListener("change",()=>{wnd.Janitor.HiddenGemsFurryFilter=r.checked}),e.appendChild(r)}function M(e){e.canBeDeleted=t=>!0,typeof e.canEditMessage_ORIGINAL>"u"&&(e.canEditMessage_ORIGINAL=e.canEditMessage),e.canEditMessage=t=>t.id==(e.messages.at(0).id??0)?e.canEditMessage_ORIGINAL.call(e,{...t,id:1}):e.canEditMessage_ORIGINAL.call(e,t),typeof e.chatStore<"u"&&typeof e.chatStore.bufferedMessageStore<"u"&&typeof e.chatStore.bufferedMessageStore.pauseBufferedStreaming<"u"&&typeof e.chatStore.bufferedMessageStore.unpauseBufferedStreaming<"u"&&(e.chatStore.bufferedMessageStore.pauseBufferedStreaming=e.chatStore.bufferedMessageStore.unpauseBufferedStreaming)}var w=e=>e.toLowerCase().endsWith("store");async function f(e){if(typeof e=="object"&&e)for(let t of Object.keys(e))try{if(wnd.Janitor.Stores[t])continue;if(t=="displayMessage"){wnd.Janitor.Toastify=e[t];continue}if(!w(t)||!e[t])continue;let r=t.split("-");wnd.Janitor.Stores[r[r.length-1]]=e[t],await f(e[t])}catch{continue}}async function b(){typeof wnd.Janitor.StoreProps.getCharacters>"u"||(typeof wnd.Janitor.StoreProps.getCharacters_ORIGINAL>"u"&&(wnd.Janitor.StoreProps.getCharacters_ORIGINAL=wnd.Janitor.StoreProps.getCharacters),wnd.Janitor.StoreProps.getCharacters=({page:e,...t})=>(t.special_mode=="hidden_gems"&&(t.proxyenabled=!0,t.tokens=500,t.tokens_mode="gte",t.tag_id=wnd.Janitor.HiddenGemsFurryFilter?[1,53]:[1]),wnd.Janitor.StoreProps.getCharacters_ORIGINAL({page:e,...t})))}function S(e,t,r){if(typeof t=="string"&&(t.includes("createElement")?wnd.Janitor.React=e:t.includes("__esModule")&&wnd.Janitor.esModules.push(e)),r.value=="Module"&&wnd.Janitor.esModules.push(e),typeof e=="object"){for(let o of Object.keys(e))if(o.trim()=="messagesStore"&&M(e[o]),o.toLowerCase().includes("store")||typeof t=="string"&&t.toLowerCase().includes("store")){if(o.toLowerCase().includes("storeprops")){wnd.Janitor.StoreProps=e,b();continue}f(e[o]);break}}}async function l(){typeof wnd.Janitor.StoreProps>"u"||typeof wnd.Janitor.StoreProps.getCharacters>"u"||wnd.Janitor.StoreProps.getCharacters.patched||(typeof wnd.Janitor.StoreProps.getCharacters_ORIGINAL>"u"&&(wnd.Janitor.StoreProps.getCharacters_ORIGINAL=wnd.Janitor.StoreProps.getCharacters),wnd.Janitor.StoreProps.getCharacters=async(...e)=>{let t=await wnd.Janitor.StoreProps.getCharacters_ORIGINAL(...e);return wnd.Janitor.StoreProps.characters=wnd.Janitor.StoreProps.characters.filter(r=>r.is_proxy_enabled&&r.avatar!="placeholder-nsfw.webp").sort((r,o)=>r.total_tokens<o.total_tokens),console.warn("filtered characters",wnd.Janitor.StoreProps.characters.length),t},wnd.Janitor.StoreProps.getCharacters.patched=!0)}function h(e,t){if(!(typeof e!="object"||!e)){for(let r of Object.values(e))if(!(typeof r!="object"||!r)){for(let o of Object.keys(r))if(o.includes(t))return r}}}function G(){wnd.Janitor.ReactDOM=h(wnd.Janitor.MainModule,"hydrateRoot"),wnd.Janitor.ReactJSX=h(wnd.Janitor.MainModule,"jsx")}async function y(){let e="";for(let o of document.querySelectorAll("script"))if(o.src.includes("/index-")){e=o.src;break}let t=document.createElement("script");t.type="module";let r=`import * as main from "${e}";
(async () => {
    while (typeof window.Janitor == "undefined") await new Promise(resolve => setTimeout(resolve, 100));
    window.Janitor.MainModule = main
})()`;for(t.textContent=r,document.body.appendChild(t);typeof wnd.Janitor.MainModule>"u"||wnd.Janitor.MainModule==null;)await new Promise(o=>setTimeout(o,100));document.body.removeChild(t),G()}function m(){wnd.Janitor.TTSEnabled=!wnd.Janitor.TTSEnabled,localStorage.setItem("TTSEnabled",wnd.Janitor.TTSEnabled+""),console.log(`TTS is now ${wnd.Janitor.TTSEnabled?"enabled":"disabled"}`),wnd.Janitor.TTSEnabled?u():(wnd.Janitor.Hooks.Delta=(...e)=>{},wnd.Janitor.Hooks.StopStream=(...e)=>{},wnd.Janitor.Hooks.SaveMessage=e=>{})}function J(){wnd.Janitor.UseDeltaForTTS=!wnd.Janitor.UseDeltaForTTS,localStorage.setItem("UseDeltaForTTS",wnd.Janitor.UseDeltaForTTS+""),console.log(`Delta TTS is now ${wnd.Janitor.UseDeltaForTTS?"enabled":"disabled"}`)}function g(e){GM.xmlHttpRequest({method:"POST",url:"http://127.0.0.1:3246/tts",headers:{"Content-Type":"application/json"},data:JSON.stringify(e),onerror:function(t){console.error("Request failed:",t)}})}function P(e){let t=[],r=/(\*\*`.*?`\*\*|\*`.*?`\*|`.*?`|\*\*.*?\*\*|\*.*?\*|"[^"]*"|\S+)/g,o=e.match(r)||[];for(let n of o){let i=n,a="chat";n.startsWith("**`")&&n.endsWith("`**")?(i=n.slice(3,-3).trim(),a="thought"):n.startsWith("*`")&&n.endsWith("`*")?(i=n.slice(2,-2).trim(),a="thought"):n.startsWith("`")&&n.endsWith("`")?(i=n.slice(1,-1).trim(),a="thought"):n.startsWith("**")&&n.endsWith("**")?(i=n.slice(2,-2).trim(),a="action"):n.startsWith("*")&&n.endsWith("*")?(i=n.slice(1,-1).trim(),a="action"):n.startsWith('"')&&n.endsWith('"')&&(i=n.slice(1,-1).trim(),a="chat"),t.push({text:i,type:a})}return t}function u(){var e="";wnd.Janitor.Hooks.Delta=t=>{if(wnd.Janitor.UseDeltaForTTS)for(let r of[".","?","!","*"])t.includes(r)&&e.replaceAll(r,"").trim().length>0&&(g({text:e.trim()}),e="")},wnd.Janitor.Hooks.StopStream=()=>{wnd.Janitor.UseDeltaForTTS&&e.trim().length>0&&g({text:e.trim()})},wnd.Janitor.Hooks.SaveMessage=t=>{if(wnd.Janitor.UseDeltaForTTS||!t.is_bot)return;let r=t.message;if(r.trim().length>0)for(let o of P(r.trim()))g(o)}}async function T(){for(;typeof wnd.__STATSIG__>"u"||typeof wnd.__STATSIG__.instances>"u"||Object.values(wnd.__STATSIG__.instances).length==0;)await new Promise(e=>setTimeout(e,100));for(let e of Object.values(wnd.__STATSIG__.instances))e.shutdown(),e._logger.reset(),e._logger.stop(),e._logger._sdkKey="",e._logger._sendEvents=null}(async()=>{let e=typeof unsafeWindow<"u"?unsafeWindow:window;globalThis.wnd=e,e.Janitor={ToggleTTS:m,ToggleDeltaTTS:J,UseDeltaForTTS:localStorage.getItem("UseDeltaForTTS")=="true",Hooks:{Delta:(...n)=>{},StopStream:(...n)=>{},SaveMessage:n=>{}},Toastify:null,Stores:{},StoreProps:{},TTSEnabled:localStorage.getItem("TTSEnabled")=="true",Generation:{},HiddenGemsFurryFilter:!1,Navigate:(...n)=>{},InitState:null,React:null,ReactDOM:null,ReactJSX:null,esModules:[],MainModule:null},T();let t=Object.defineProperty;e.Object.defineProperty=(n,i,a)=>{let p=t(n,i,a);return document.body&&document.body.innerText.includes("security verification")||S(n,i,a),p};let r=Map.prototype.has;Map.prototype.has=function(...n){for(let i of this.keys())if(typeof i=="string"&&w(i)){f(Object.fromEntries(this));break}return r.call(this,...n)};let o=Object.prototype.hasOwnProperty;for(Object.prototype.hasOwnProperty=function(n){return o.call(this,n)},e.Janitor.TTSEnabled&&u(),(async()=>{if(window.location.href.includes("/chat")){for(;typeof e.Janitor.Stores.generationStore>"u";)await new Promise(n=>setTimeout(n,100));await d()}})(),(async()=>{if(window.location.href.includes("/search")){for(;typeof e.Janitor.StoreProps>"u"||typeof e.Janitor.StoreProps.getCharacters>"u";)await new Promise(n=>setTimeout(n,100));await l()}})(),(async()=>{for(;typeof e.Janitor.Stores.navigatorStore>"u"||typeof e.Janitor.Stores.navigatorStore.navigate>"u";)await new Promise(a=>setTimeout(a,100));e.Janitor.Navigate=e.Janitor.Stores.navigatorStore.navigate;var n=window.location.href;new MutationObserver(a=>{window.location.href!=n&&(n=window.location.href,window.location.href.includes("/chat")?d():window.location.href.includes("/search")&&l(),c())}).observe(document.body,{childList:!0,subtree:!0})})(),console.log("Janitor qol n shi loaded!");typeof e.Janitor.React>"u"||typeof e.Janitor.React?.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED>"u"||typeof e.Janitor.React?.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED?.ReactCurrentDispatcher>"u"||typeof e.Janitor.React?.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED?.ReactCurrentDispatcher?.current>"u";)await new Promise(n=>setTimeout(n,100));for(console.log("react"),y();typeof e.Janitor.Toastify>"u"||typeof e.Janitor.Toastify?.showInfo>"u";)await new Promise(n=>setTimeout(n,100));e.Janitor.Toastify.showInfo("Loaded!"),c()})();})();
